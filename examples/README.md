# External Key Loading Examples

This directory contains examples demonstrating the secure external key loading functionality of the Ecliptix Security library.

## Security Improvement

**Previous approach (INSECURE):** Private keys were embedded directly in the binary with weak XOR obfuscation.

**New approach (SECURE):** Private keys are loaded externally at runtime from secure sources.

## Quick Start

### 1. Generate Test Keys

```bash
./generate_test_keys.sh
```

This creates RSA key pairs in the `test_keys/` directory:
- `server_private_key.pem` / `server_public_key.pem`
- `client_private_key.pem` / `client_public_key.pem`

### 2. Build the Example

```bash
# From the project root directory
mkdir -p build && cd build
cmake .. -DECLIPTIX_BUILD_TESTS=ON
make external_key_example
```

### 3. Run the Example

```bash
cd examples
./external_key_example test_keys/server_private_key.pem test_keys/client_private_key.pem
```

## API Usage

### Server Initialization

```cpp
// Load private key from file/memory
std::vector<uint8_t> server_key = load_private_key("server_key.pem");

// Initialize with external key
int result = ecliptix_server_init_with_key(server_key.data(), server_key.size());
if (result != ECLIPTIX_SUCCESS) {
    std::cerr << "Server init failed: " << ecliptix_server_get_error() << std::endl;
}
```

### Client Initialization

```cpp
// Load private key from file/memory
std::vector<uint8_t> client_key = load_private_key("client_key.pem");

// Initialize with external key
int result = ecliptix_client_init_with_key(client_key.data(), client_key.size());
if (result != ECLIPTIX_SUCCESS) {
    std::cerr << "Client init failed: " << ecliptix_client_get_error() << std::endl;
}
```

## Key Management Best Practices

### Development/Testing
- Use the provided `generate_test_keys.sh` script
- Store keys in files with proper permissions (600 for private keys)
- Never commit private keys to version control

### Production Deployment
- **Environment Variables:** Load keys from secure environment variables
- **Key Management Services:** Use AWS KMS, Azure Key Vault, or HashiCorp Vault
- **Hardware Security Modules (HSMs):** For maximum security
- **Configuration Files:** With proper file permissions and encryption at rest

### Example: Loading from Environment Variable

```cpp
const char* server_key_env = std::getenv("ECLIPTIX_SERVER_PRIVATE_KEY");
if (!server_key_env) {
    std::cerr << "ECLIPTIX_SERVER_PRIVATE_KEY environment variable not set" << std::endl;
    return -1;
}

int result = ecliptix_server_init_with_key(
    reinterpret_cast<const uint8_t*>(server_key_env),
    strlen(server_key_env)
);
```

### Example: Loading from Configuration File

```cpp
std::ifstream key_file("config/server_private_key.pem", std::ios::binary);
std::string key_content((std::istreambuf_iterator<char>(key_file)),
                        std::istreambuf_iterator<char>());

int result = ecliptix_server_init_with_key(
    reinterpret_cast<const uint8_t*>(key_content.c_str()),
    key_content.size()
);
```

## Security Benefits

1. **No Embedded Secrets:** Private keys are never baked into binaries
2. **Key Rotation:** Keys can be updated without recompiling
3. **Environment-Specific Keys:** Different keys for dev/staging/production
4. **Access Control:** File permissions and key management systems provide proper access control
5. **Compliance:** Meets security standards that prohibit embedded secrets

## Migration Guide

If migrating from the old embedded key approach:

1. **Replace `ecliptix_server_init()`** with `ecliptix_server_init_with_key()`
2. **Replace `ecliptix_client_init()`** with `ecliptix_client_init_with_key()`
3. **Implement key loading** from your preferred secure source
4. **Update deployment scripts** to provide keys at runtime
5. **Test thoroughly** with your key management approach

## Troubleshooting

### "Failed to load provided private key - invalid format or corrupted"
- Ensure the key is in PEM format
- Verify the key file is not corrupted
- Check that you're loading the private key, not the public key

### "Invalid private key parameters"
- Ensure the key data pointer is not null
- Verify the key size is greater than 0
- Check for proper null-termination if loading from strings

### "Server/Client already initialized"
- Call `ecliptix_server_cleanup()` or `ecliptix_client_cleanup()` before re-initializing
- This is not an error if initialization was already successful

## Security Warning

⚠️ **Never use the test keys generated by `generate_test_keys.sh` in production environments!**

These keys are for development and testing only. Production systems must use properly managed, unique cryptographic keys.